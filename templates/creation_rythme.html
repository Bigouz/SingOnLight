<!doctype html>
<html>

<head>
    <title>Sing On Light - Jouer</title>
</head>

<body>
    <div class="parent">
        <div class="div1">
            <div class="div1a">
                <a class="indexBTN" href="/">Menu Principal</a><br>
                <a class="playBTN" href="/Mode.html">Jouer</a><br>
                <a class="calibrationBTN" href="/calibration.html">Calibration</a><br>
                <a class="dataBTN" href="/data.html">Données</a><br>
                <a class="creationBTN" id="currentBTN" href="/creation_rythme.html">Créer son propre rythme!</a><br>
                <a href="https://github.com/Bigouz/Projet-L1-Informatique-1er-semestre" target="_blank"
                    class="github">GitHub</a>

            </div>
        </div>
        <div class="div2">
            <h1>Sing On Light - Créer son rythme</h1>
            <div class="text">
                <p>Après avoir créé <strong>votre propre rythme</strong> pour vous entraîner,
                    <br>appuyez sur "Jouer" et la partie commencera <strong>immédiatement</strong>.
                <p>Quand la LED s'allume, faites un <strong>bruit continu</strong> (chanter, siffler, etc.).</p>
                <div class="container" style="min-width: 640px;">
                    <h2>Paramètres de la partie</h2>
                    <p>Choisissez vos <strong>paramètres</strong> pour le rythme ci-dessous :</p>


                    <label for="dureePartie"><strong>Durée</strong> de la partie (en intervalles) : </label>
                    <input type="number" name="dureePartie" id="dureePartie" value="{{dureePartie}}" max="120" min="5"
                        onchange="this.value=this.value.replace(/[^0-9]/g,''); if(this.value<5)this.value=5; if(this.value>120)this.value=120;creer_cases(this.value)"><br><br>
                    <fieldset>
                        <legend>Rythme</legend>
                    </fieldset>


                    <span id="temps_total"> </span>
                    <p><button id="create" class="create" onclick=save_param(this);>Créer</button></p>
                </div>
                <span id="rythme" style="opacity: 0;">{{rythme}}</span>

                <br><br>
                <p style="color: lime;" id="result">{{message}}</p>
                </p>
                <br><br>
                <p id="temps"></p>

                <script>

                    function creer_cases(n) {
                        const fieldset = document.querySelector("fieldset");
                        fieldset.innerHTML = '<legend>Rythme</legend>';
                        for (let i = 1; i <= n; i++) {
                            const label = document.createElement("label");
                            label.setAttribute("for", "intervalle" + i);
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.id = "intervalle" + i;
                            checkbox.name = "Int" + i;
                            label.appendChild(checkbox);
                            fieldset.appendChild(label);
                        }
                    }

                    let rythme = document.getElementById("rythme").innerText;
                    document.getElementById("dureePartie").value = Math.max(rythme.length, 5);

                    creer_cases(document.getElementById("dureePartie").value);

                    console.log(rythme);
                    for (let i = 0; i < rythme.length; i++) {
                        if (rythme.charAt(i) === '1') {
                            document.getElementById("intervalle" + (i + 1)).checked = true;
                        } else {
                            document.getElementById("intervalle" + (i + 1)).checked = false;
                        }
                    }


                    function change_value(t) {
                        t.value = t.value.replace(/,/g, '.').replace(/[^0-9.]/g, '');
                        let v = parseFloat(t.value);
                        if (isNaN(v)) v = 0.1;
                        if (v < 0.1) v = 0.1;
                        if (v > 2.0) v = 2.0;
                        // arrondi au pas de 0.1
                        v = Math.round(v * 10) / 10;
                        t.value = v.toFixed(1);
                    }

                    async function save_param() {
                        document.getElementById("create").innerText = "Le rythme a été créé.";

                        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                        let values = Array.from(checkboxes).map(checkbox => checkbox.id);

                        for (let i = 0; i < checkboxes.length; i++) {
                            if (checkboxes[i].checked) {
                                values[i] = 1;
                            } else {
                                values[i] = 0;
                            }
                        }
                        console.log(values);
                        values = values.join('');
                        console.log(values);
                        const response = await fetch('/run_creation_rythme', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ "rythme": values })
                        });

                    };
                </script>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="static/css/style.css">
</body>

</html>
