<!doctype html>
<html>
<head>
<title>Sing On Light - Jouer</title>
</head>
<body>
<div class = "parent">
    <div class="div1">
        <div class = "div1a">
            <a class="indexBTN" href="/">Menu Principal</a><br>
            <a class="playBTN" id="currentBTN" href="/Mode.html">Jouer</a><br>
            <a class="calibrationBTN" href="/calibration.html">Calibration</a><br>
            <a class="dataBTN" href="/data.html">DonnÃ©es</a><br>
            <a class="creationBTN" href="/creation_rythme.html">CrÃ©er son propre rythme!</a><br>
            <a href="https://github.com/Bigouz/Projet-L1-Informatique-1er-semestre" target="_blank" class="github">GitHub</a>

        </div>    
    </div>
    <div class="div2">
        <h1>Sing On Light - CrÃ©er son rythme</h1>
        <div class="text">
            <p>AprÃ¨s avoir crÃ©er votre propre rythme pour vous entrainer, 
            <br>appuyez sur "Jouer" et la partie commencera immÃ©diatement. 
            <br><br>Quand la LED s'allume, faites un bruit continu (chanter, siffler, etc.).
            <br>
            <div class="container" style="min-width: 640px;">
                <h2>ParamÃ¨tres de la partie</h2>
                </br>Choisissez vos paramÃ¨tres de jeu ci-dessous :
                <br><br>

                <label for="dureeIntervalle">DurÃ©e d'intervalles (en secondes) : </label>
                <input type="number" name="dureeIntervalle" id="dureeIntervalle" value="{{dureeIntervalle}}" max="2" min="0.1" step="0.1" onchange="change_value(this);temps_total()"><br>

                <label for="dureePartie">DurÃ©e de la partie (en intervalles) : </label>
                <input type="number" name="dureePartie" id="dureePartie" value="{{dureePartie}}" max="120" min="5" onchange="this.value=this.value.replace(/[^0-9]/g,''); if(this.value<5)this.value=5; if(this.value>120)this.value=120;temps_total()" ><br><br>
                
                <fieldset>
                <legend>Rythme</legend>
                <label for="Int1"><input type="checkbox" id="intervalle1" name="whatever"></label>
                <label for="Int2"></label><input type="checkbox" id="intervalle2" name="whatever"></label>
                <label for="Int3"></label><input type="checkbox" id="intervalle3" name="whatever"></label>
                <label for="Int4"></label><input type="checkbox" id="intervalle4" name="whatever"></label>
                </fieldset>

                <br><br>
                <span id="temps_total"> </span><br>
                <button id="start" class="start" onclick="this.disabled = true;save_param()">Jouer</button>
                <p id = "winstreak">ðŸ”¥ðŸ”¥ðŸ”¥ Winstreak: {{winstreak}} ðŸ”¥ðŸ”¥ðŸ”¥ </p>
            </div>
            
            
            <br><br>
            <p style="color: lime;" id="result">{{message}}</p>
            </p>
            <br><br>
            <p id="temps"></p>
            
            <script>
                function change_value(t){
                    t.value = t.value.replace(/,/g, '.').replace(/[^0-9.]/g, '');
                    let v = parseFloat(t.value);
                    if (isNaN(v)) v = 0.1;
                    if (v < 0.1) v = 0.1;
                    if (v > 2.0) v = 2.0;
                    // arrondi au pas de 0.1
                    v = Math.round(v * 10) / 10;
                    t.value = v.toFixed(1);
                }
            
            
                function temps_total(){
                    let temps = Math.round(document.getElementById("dureePartie").value * document.getElementById("dureeIntervalle").value);
                    document.getElementById("temps_total").innerHTML = "Temps total de la partie : " + temps + " secondes";
                    return temps;
                }
                temps_total()

            const delay = ms => new Promise(res => setTimeout(res, ms));
            async function save_param() {
                document.getElementById("temps").innerText = "La partie commence dans 3 secondes.";
                await delay(1000);
                document.getElementById("temps").innerText = "La partie commence dans 2 secondes.";
                await delay(1000);
                document.getElementById("temps").innerText = "La partie commence dans 1 secondes.";
                await delay(1000);
                document.getElementById("temps").innerText = "";
                
                const dureeIntervalle = parseFloat(document.getElementById('dureeIntervalle').value);
                const dureePartie = parseInt(document.getElementById('dureePartie').value);

                
                const response = await fetch('/run_play', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({"dureeIntervalle":dureeIntervalle, "dureePartie":dureePartie})
                });
                const data = await response.json();
                document.getElementById('result').innerText = data["message"];
                document.getElementById('result').style.color = data["message"].includes("gagnÃ©") ? "lime" : "red";
                document.getElementById('winstreak').innerText = "ðŸ”¥ðŸ”¥ðŸ”¥ Winstreak: " + data["winstreak"] + " ðŸ”¥ðŸ”¥ðŸ”¥";


                document.getElementById('start').disabled = false;
            }
        </script>
        </div>
    </div>
</div>
<link rel="stylesheet" href="static/css/style.css">
</body>
</html>
